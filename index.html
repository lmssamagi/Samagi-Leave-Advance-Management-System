const LEAVE_SHEET_NAME   = 'Leaves';
const ADVANCE_SHEET_NAME = 'SalaryAdvances';
const NOTIFY_EMAIL       = 'lmssamagi@gmail.com'; // notification email

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const ss   = SpreadsheetApp.getActiveSpreadsheet();
    const now  = new Date();

    if (data.type === 'leave') {
      return handleSimpleLeave(ss, data, now);
    } else if (data.type === 'advance') {
      return handleSimpleAdvance(ss, data, now);
    } else {
      return jsonResponse({ success: false, error: 'Invalid type' });
    }

  } catch (err) {
    return jsonResponse({ success: false, error: err.toString() });
  }
}

// ===== LEAVE HANDLER =====
function handleSimpleLeave(ss, data, now) {
  const sheet = ss.getSheetByName(LEAVE_SHEET_NAME);

  sheet.appendRow([
    now,
    data.employeeCode,
    data.employeeName,
    data.requestDate,
    data.leaveType,
    data.leaveFrom,
    data.leaveTo,
    data.numDays,
    data.reason || ''
  ]);

  const subject = 'New Leave Request - ' + data.employeeCode + ' / ' + data.employeeName;
  const body =
    'A new leave request has been submitted.\n\n' +
    'Employee Code: ' + data.employeeCode + '\n' +
    'Employee Name: ' + data.employeeName + '\n' +
    'Date of Request: ' + data.requestDate + '\n' +
    'Leave Type: ' + data.leaveType + '\n' +
    'Leave From: ' + data.leaveFrom + '\n' +
    'Leave To: ' + data.leaveTo + '\n' +
    'Number of Days: ' + data.numDays + '\n' +
    'Reason: ' + (data.reason || '-') + '\n\n' +
    'This is an automated notification from the Samagi Employee Portal.';

  MailApp.sendEmail({
    to: NOTIFY_EMAIL,
    subject: subject,
    body: body
  });

  return jsonResponse({ success: true });
}

// ===== SALARY ADVANCE HANDLER (no recovery plan) =====
function handleSimpleAdvance(ss, data, now) {
  const sheet = ss.getSheetByName(ADVANCE_SHEET_NAME);

  sheet.appendRow([
    now,
    data.employeeCode,
    data.employeeName,
    data.requestDate,
    data.amount,
    data.reason || ''
  ]);

  const subject = 'New Salary Advance Request - ' + data.employeeCode + ' / ' + data.employeeName;
  const body =
    'A new salary advance request has been submitted.\n\n' +
    'Employee Code: ' + data.employeeCode + '\n' +
    'Employee Name: ' + data.employeeName + '\n' +
    'Date of Request: ' + data.requestDate + '\n' +
    'Amount: ' + data.amount + '\n' +
    'Reason: ' + (data.reason || '-') + '\n\n' +
    'This is an automated notification from the Samagi Employee Portal.';

  MailApp.sendEmail({
    to: NOTIFY_EMAIL,
    subject: subject,
    body: body
  });

  return jsonResponse({ success: true });
}

// ===== helper =====
function jsonResponse(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
